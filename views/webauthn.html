
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WebAuthn with Cognito</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.jsdelivr.net/gh/herrjemand/Base64URL-ArrayBuffer@latest/lib/base64url-arraybuffer.js"></script>
    <script src="https://demowebapp.s3-us-west-2.amazonaws.com/cbor.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://demowebapp.s3-us-west-2.amazonaws.com/amazon-cognito-identity.js"></script>
    
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    
  </head>
  <body class="w3-container">

      <h2>
        WebAuthn with Cognito
      </h2>
      
      <div id="tabs">
        <ul>
          <li><a href="#tabs-1">Register</a></li>
          <li><a href="#tabs-2">Sign-in</a></li>
        </ul>
        <div id="tabs-1">
          <input class="w3-input"  type="text" id="reg-username" placeholder="username"/><br>
          <input class="w3-input" type="text" id="reg-email" placeholder="email"/><br>
          <input class="w3-input" type="text" id="reg-name" placeholder="name"/><br>
          <button class="w3-btn w3-black" onclick="createCredential()">Register</button> 
        </div>
        <div id="tabs-2">
          <input class="w3-input" type="text" id="login-username" placeholder="username"/><br>
          <button class="w3-btn w3-black" onclick="signIn()">Login</button> 
        </div>
      </div>
      <br><br>
      <div class="w3-panel w3-card" id="idToken"></div>
      <div class="w3-panel w3-card" id="accessToken"></div>
      <div class="w3-panel w3-card" id="refreshToken"></div>
  </body>
</html>

<script>
  
  let registeredCredentials;
  let registeredCredentialsJSON;
  
  var poolData = {
    UserPoolId: 'us-west-2_u9wH1PqeY', // Your user pool id here
    ClientId: '8omcu8gui2s8ugi4uejonqo8c' //Your app client id here
  };
  var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
  
  //create credentials using platform or roaming authenticator
  const createCredential = async () => {
      try {
        
          //build the credentials options requirements
          var credOptionsRequest = {
            attestation: 'none',
            username: $("#reg-username").val() ,
            name: $("#reg-username").val(),
            authenticatorSelection: {
              authenticatorAttachment: ['platform','cross-platform'],
              userVerification: 'preferred',
              requireResidentKey: false
            }
          };
          
          //generate credentials request to be sent to navigator.credentials.create
          var credOptions = await _fetch('/authn/createCredRequest' , credOptionsRequest);
          var challenge = credOptions.challenge;
          credOptions.user.id = base64url.decode(credOptions.user.id);
          credOptions.challenge = base64url.decode(credOptions.challenge);
          
          //----------create credentials using available authenticator
          const cred = await navigator.credentials.create({
              publicKey: credOptions
          });
          
          // parse credentials response to extract id and public-key, this is the information needed to register the user in Cognito
          const credential = {};
          credential.id =     cred.id;
          credential.rawId =  base64url.encode(cred.rawId);
          credential.type =   cred.type;
          credential.challenge = challenge;
          
          if (cred.response) {
            const clientDataJSON = base64url.encode(cred.response.clientDataJSON);
            const attestationObject = base64url.encode(cred.response.attestationObject);
            credential.response = {
              clientDataJSON,
              attestationObject
            };
          }
          
          credResponse = await _fetch('/authn/parseCredResponse' , credential);
          
          registeredCredentialsJSON = {id: credResponse.credId,publicKey: credResponse.publicKey};
          registeredCredentials = JSON.stringify(registeredCredentialsJSON);
          console.log(registeredCredentials);
          
          //----------credentials have been created, now sign-up the user in Cognito
          signUp();
        
      } catch (e) {console.error(e);}
  };

  //---------------Cognito sign-up
  function signUp(){
  
      var email = $("#reg-email").val();
      var username = $("#reg-username").val();
      var password = Math.random().toString(36).slice(-8) + "@" +Math.random().toString(36).slice(-5).toUpperCase();//random password
      var name = $("#reg-name").val();
      var publicKeyCred = btoa(registeredCredentials);//base64 encode credentials json string (credId, public-key)
      
      var attributeList = [];
  
      var dataEmail = {Name: 'email',Value: email};
      var dataName = { Name: 'name',Value: name};
      var dataPublicKeyCred = { Name: 'custom:publicKeyCred',Value: publicKeyCred};
      
      var attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute(dataEmail);
      var attributePublicKeyCred = new AmazonCognitoIdentity.CognitoUserAttribute(dataPublicKeyCred);
      var attributeName = new AmazonCognitoIdentity.CognitoUserAttribute(dataName);
  
      attributeList.push(attributeEmail);
      attributeList.push(attributePublicKeyCred);
      attributeList.push(attributeName);
      
      userPool.signUp(username, password, attributeList, null, function(err, result ) {
        if (err) {
          console.log(err.message || JSON.stringify(err));
          return;
        }else{
          var cognitoUser = result.user;
          
          var confirmationCode = prompt("Please enter confirmation code:");
          cognitoUser.confirmRegistration(confirmationCode, true, function(err, result) {
            if (err) {
              alert(err.message || JSON.stringify(err));
              return;
            }
            console.log('call result: ' + result);
            alert("Registration successful, now sign-in.");
          });
          
          console.log('user name is ' + cognitoUser.getUsername());
        }
      });
  }


  //---------------Cognito sign-in user
  const signIn = async () => {
  
      var username = $("#login-username").val();
      var authenticationData = {
        Username: username //only username required since we will authenticate user using custom auth flow and will use security key
      };
      
      var userData = {
        Username: username,
        Pool: userPool,
      };
  
      var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
      cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
      
      cognitoUser.setAuthenticationFlowType('CUSTOM_AUTH');
      cognitoUser.initiateAuth(authenticationDetails, {
      	
        onSuccess: function(result) {
          var accessToken = result.getAccessToken().getJwtToken();
          var idToken = result.getIdToken().getJwtToken();
          var refreshToken = result.getRefreshToken().getToken();
          
          $("#idToken").html('<b>ID Token</b><br>'+JSON.stringify(parseJwt(idToken)));
          $("#accessToken").html('<b>Access Token</b><br>'+JSON.stringify(parseJwt(accessToken)));
          $("#refreshToken").html('<b>Refresh Token</b><br>'+refreshToken);
  
        },
        customChallenge: async function(challengeParameters) {
          // User authentication depends on challenge response
          
          console.log("Custom Challenge from Cognito:");console.log(challengeParameters);
          
          
          //----------get creds from security key or platform authenticator
          var signinOptions = {
             "challenge": base64url.decode(challengeParameters.challenge),//challenge was generated and sent from CreateAuthChallenge lambda trigger
             "timeout":1800000,
             "rpId":window.location.hostname,
             "userVerification":"preferred",
             "allowCredentials":[
                {
                   "id": base64url.decode(challengeParameters.credId),
                   "type":"public-key",
                   "transports":["ble","nfc","usb","internal"]
                }
             ]
          }
          
          //get sign in credentials from authenticator
          const cred = await navigator.credentials.get({
            publicKey: signinOptions
          });
          
          //prepare credentials challenge response
          const credential = {};
          if (cred.response) {
            const clientDataJSON = base64url.encode(cred.response.clientDataJSON);
            const authenticatorData = base64url.encode(cred.response.authenticatorData);
            const signature = base64url.encode(cred.response.signature);
            const userHandle = base64url.encode(cred.response.userHandle);
            
            credential.response = {clientDataJSON, authenticatorData, signature, userHandle};
          }
          
          //send credentials to Cognito VerifyAuthChallenge lambda trigger for verification
          cognitoUser.sendCustomChallengeAnswer(JSON.stringify(credential), this);
          
        },
        onFailure: function(err) {
        	console.error("Error authenticateUser:"+err);
          console.log(err.message || JSON.stringify(err));
        },
      });
  }

  //---------------------Set of helper functions-----------------------//
  //------------------------------------------------------------------//
  function randomString(length){
    for(var a = ''; a.length < length;) a += "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz"[(Math.random() * 60) | 0]
    
    return a;
  }

  function toArrayBuffer(buf, name) {
  
      // Buffer or Array to Uint8Array
      if (Array.isArray(buf)) {
          buf = new Uint8Array(buf);
      }
  
      // Uint8Array to ArrayBuffer
      if (buf instanceof Uint8Array) {
          buf = buf.buffer;
      }
  
      return buf;
  }

  //array buffer to string conversion function
  function arrayBuffToStr(buf) {
      var str = "";
      new Uint8Array(buf).forEach((ch) => {
          str += String.fromCharCode(ch);
      });
      return str;
  }

  //tabs UI
  $( function() {
    $( "#tabs" ).tabs();
  } );

  //helper function
  const _fetch = async (path, payload = '') => {
    const headers = {'X-Requested-With': 'XMLHttpRequest'};
    if (payload && !(payload instanceof FormData)) {
      headers['Content-Type'] = 'application/json';
      payload = JSON.stringify(payload);
    }
    const res = await fetch(path, {
      method: 'POST',
      credentials: 'same-origin',
      headers: headers,
      body: payload
    });
    if (res.status === 200) {
      return res.json();
    } else {
      const result = await res.json();
      throw result.error;
    }
  };
  
  function parseJwt (token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace('-', '+').replace('_', '/');
      return JSON.parse(window.atob(base64));
  };

</script>
